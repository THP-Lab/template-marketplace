<% if notice.present? %>
  <p style="color: green"><%= notice %></p>
<% end %>

<% content_for :title, "Événements" %>
<% content_for :meta_description, "Calendrier des marchés médiévaux, ateliers et rencontres à venir organisés par l'atelier." %>
<% content_for :structured_data do %>
  <% listed_events = @events.respond_to?(:limit) ? @events.first(20) : Array(@events).first(20) %>
  <%= jsonld_tag(item_list_schema(listed_events,
                                  type: "Event",
                                  name: "Calendrier des événements",
                                  url_proc: ->(event) { event_url(event) })) %>
<% end %>

<section class="section-wrapper">
  <h1 class="h1">Événements</h1>

  <div class="calendar calendar--wide">
    <%= month_calendar(events: @events) do |date, events| %>
      <% cell_classes = ["calendar-day"] %>
      <% if events.size >= 3 %>
        <% cell_classes << "calendar-day--event-strong" %>
      <% elsif events.size == 2 %>
        <% cell_classes << "calendar-day--event-mid" %>
      <% elsif events.any? %>
        <% cell_classes << "calendar-day--event" %>
      <% end %>
      <% cell_classes << "calendar-day--today" if date == Date.current %>

      <% category_icons = {
        "Marché médiéval" => "bi-shop",
        "Atelier" => "bi-hammer",
        "Reconstitution" => "bi-cast",
        "En ligne" => "bi-wifi"
      } %>
      <% icons = events.map { |e| category_icons[e.category.to_s] }.compact.uniq.first(3) %>

      <div class="<%= cell_classes.join(" ") %>">
        <div class="calendar-day__number"><%= date.day %></div>

        <% if icons.any? %>
          <div class="calendar-day__icons" aria-hidden="true">
            <% icons.each do |icon| %>
              <i class="bi <%= icon %>"></i>
            <% end %>
          </div>
          <span class="visually-hidden"><%= icons.size %> événement(s) ce jour</span>
        <% end %>

      </div>
    <% end %>
  </div>

  <div class="events-grid" id="events">
    <% @events.each do |event| %>
      <%= render event %>
    <% end %>
  </div>

  <%= link_to "New event", new_event_path, class: "btn btn--secondary" %>
</section>

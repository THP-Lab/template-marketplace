<% content_for :title, "Admin - Paniers : informations" %>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-4 col-xl-3">
      <%= render_admin_sidebar %>
    </div>
    <div class="col-lg-8 col-xl-9">
      <h1 class="mb-4">Paniers - informations d√©taill√©es</h1>

      <% if notice.present? %>
        <div class="alert alert-success"><%= notice %></div>
      <% end %>

      <% if @carts.present? %>
        <div class="row g-4">
          <% @carts.each do |cart| %>
            <% cart_products = cart.cart_products %>
            <% total_quantity = cart_products.sum { |cart_product| cart_product.quantity.to_i } %>
            <% cart_total = cart_products.sum do |cart_product|
                 unit_price = cart_product.unit_price || cart_product.product&.price || 0
                 unit_price.to_d * cart_product.quantity.to_i
               end %>

            <div class="col-12">
              <div class="card shadow-sm h-100" data-controller="toggle-details">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <div class="fw-semibold mb-1">Panier #<%= cart.id %></div>
                    <div class="text-muted small">
                      Statut : <%= cart.status.presence || "‚Äî" %> |
                      Cr√©√© le : <%= cart.created_at&.strftime("%d/%m/%Y %H:%M") %> |
                      Utilisateur : <%= cart.user.present? ? mask_email(cart.user.email) : "‚Äî" %>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-dark border">Articles : <%= total_quantity %></span>
                    <span class="badge bg-primary">Total : <%= number_to_currency(cart_total, unit: "‚Ç¨") %></span>
                    <button class="btn btn-outline-secondary btn-sm" data-action="toggle-details#toggle" type="button" title="Voir les informations utilisateur">üëÅÔ∏è</button>
                  </div>
                </div>

                <div class="card-body p-0">
                  <% if cart_products.any? %>
                    <div class="list-group list-group-flush">
                      <% cart_products.each do |cart_product| %>
                        <% product = cart_product.product %>
                        <% unit_price = cart_product.unit_price || product&.price || 0 %>
                        <% line_total = unit_price.to_d * cart_product.quantity.to_i %>

                        <div class="list-group-item d-flex justify-content-between align-items-start">
                          <div>
                            <div class="fw-semibold"><%= product&.title.presence || "Produit ##{cart_product.product_id}" %></div>
                            <div class="text-muted small">
                              Quantit√© : <%= cart_product.quantity || 0 %> |
                              Prix unitaire : <%= number_to_currency(unit_price, unit: "‚Ç¨") %>
                            </div>
                          </div>
                          <div class="text-end">
                            <div class="fw-semibold"><%= number_to_currency(line_total, unit: "‚Ç¨") %></div>
                            <div class="text-muted small">ID produit : <%= cart_product.product_id %></div>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <div class="p-3 text-muted">Aucun produit dans ce panier.</div>
                  <% end %>
                </div>

                <div class="card-footer d-none" data-toggle-details-target="details">
                  <% if cart.user.present? %>
                    <div class="small text-muted">
                      Email : <%= cart.user.email %> |
                      Pr√©nom : <%= cart.user.first_name.presence || "‚Äî" %> |
                      Nom : <%= cart.user.last_name.presence || "‚Äî" %> |
                      ID utilisateur : <%= cart.user.id %>
                    </div>
                  <% else %>
                    <div class="small text-muted">Utilisateur introuvable</div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-muted">Aucun panier.</p>
      <% end %>

      <div class="d-flex justify-content-end mt-3">
      </div>
      <%= admin_pagination(@pagination) %>
    </div>
  </div>
</div>

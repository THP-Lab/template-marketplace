<% about_options = AboutPage.order(:position, :title).map { |p| ["##{p.position} - #{p.title}", p.id] } %>
<% repair_options = RepairPage.order(:position, :title).map { |p| ["##{p.position} - #{p.title}", p.id] } %>

<%= form_with(model: home_page, data: { controller: "home-block-form" }) do |form| %>
  <% if home_page.errors.any? %>
    <div class="alert alert-danger">
      <h2 class="h6 mb-2"><%= pluralize(home_page.errors.count, "erreur") %> empêchent l’enregistrement :</h2>
      <ul class="mb-0">
        <% home_page.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :title, "Titre", class: "form-label" %>
    <%= form.text_field :title, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :bloc_type, "Type de bloc", class: "form-label" %>
    <%= form.select :bloc_type,
                    [["Bloc personnalisé", "custom"],
                     ["Bloc À propos", "about"],
                     ["Bloc réparation", "repair"],
                     ["Bloc boutique", "shop"]],
                    {},
                    class: "form-select",
                    data: { "home-block-form-target": "blocType", action: "change->home-block-form#toggle" } %>
    <div class="form-text">Choisissez la source du contenu affiché sur la home.</div>
  </div>

  <div class="mb-3" data-home-block-form-target="targetSection">
    <%= form.label :target_id, "Bloc cible (À propos / Réparation)", class: "form-label" %>
    <%= form.select :target_id,
                    [],
                    {},
                    class: "form-select",
                    data: {
                      "home-block-form-target": "targetSelect",
                      about_options: about_options.to_json,
                      repair_options: repair_options.to_json,
                      selected_value: home_page.target_id
                    } %>
    <div class="form-text">Utilisé uniquement si le type est “Bloc À propos” ou “Bloc réparation”.</div>
  </div>

  <div class="mb-3" data-home-block-form-target="shopSection">
    <%= form.label :shop_scope, "Sélection boutique", class: "form-label" %>
    <%= form.select :shop_scope,
                    [["5 premiers", "first"],
                     ["5 derniers", "last"],
                     ["5 plus achetés", "top_sellers"]],
                    {},
                    class: "form-select" %>
    <div class="form-text">Utilisé si le type est “Bloc boutique”.</div>
  </div>

  <div class="mb-3" data-home-block-form-target="contentSection">
    <%= form.label :content, "Contenu (bloc personnalisé)", class: "form-label" %>
    <%= form.text_area :content, class: "form-control", rows: 4 %>
    <div class="form-text">S’affiche uniquement pour les blocs personnalisés.</div>
  </div>

  <div class="mb-3" data-home-block-form-target="buttonSection">
    <%= form.label :button_label, "Texte du bouton", class: "form-label" %>
    <%= form.text_field :button_label, class: "form-control", placeholder: "Ex : Découvrir" %>
    <div class="form-text">Affiché sur le bouton du bloc (boutique, À propos, réparation).</div>
  </div>

  <div class="mb-3">
    <%= form.label :image, "Image du bloc", class: "form-label" %>
    <%= form.file_field :image, class: "form-control" %>
    <% if home_page.image.attached? %>
      <div class="mt-2">
        <%= attachment_thumb(home_page.image, variant_options: { resize_to_limit: [200, 200] }, class: "img-thumbnail") %>
      </div>
    <% end %>
  </div>

  <% if home_page.persisted? %>
    <div class="mb-3">
      <%= form.label :position, "Position", class: "form-label" %>
      <%= form.number_field :position, class: "form-control" %>
    </div>
  <% end %>

  <div class="d-flex gap-2">
    <%= form.submit "Enregistrer", class: "btn btn-primary" %>
  </div>
<% end %>
